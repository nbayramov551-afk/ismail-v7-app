<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SOVEREIGN OMEGA - THE BOSS SYSTEM</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --neon: #00ff88; --bg: #050505; --panel: #111; --text: #e0e0e0; --danger: #ff3b3b; --gold: #ffd700; }
        
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; }

        /* üî± AUTH & PROFILE SETUP */
        #setup-layer { position: fixed; inset: 0; background: var(--bg); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; transition: 0.5s; }
        .setup-card { background: var(--panel); padding: 30px; border-radius: 25px; border: 1px solid var(--neon); box-shadow: 0 0 30px rgba(0,255,136,0.2); width: 100%; max-width: 400px; }
        .profile-upload { width: 100px; height: 100px; border-radius: 50%; border: 2px dashed var(--neon); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; cursor: pointer; }
        .profile-upload img { width: 100%; height: 100%; object-fit: cover; }

        /* üî± MAIN DASHBOARD */
        .master-grid { display: grid; grid-template-rows: auto 1fr auto; height: 100vh; }
        .top-bar { height: 80px; background: var(--panel); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; border-bottom: 1px solid #222; }
        
        /* üî± CONTENT LAYERS */
        .content-scroll { overflow-y: auto; padding: 15px; background: linear-gradient(180deg, #050505 0%, #0c0c0c 100%); }
        .chat-card { background: #181818; padding: 18px; border-radius: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid #222; transition: 0.3s; }
        .chat-card:active { transform: scale(0.97); background: #222; }
        .avatar-box { width: 55px; height: 55px; border-radius: 50%; background: #333; flex-shrink: 0; border: 2px solid var(--neon); overflow: hidden; }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }

        /* üî± CHAT INTERFACE */
        #chat-window { position: fixed; inset: 0; background: var(--bg); z-index: 1000; transform: translateX(100%); transition: 0.4s cubic-bezier(0.1, 0.7, 1.0, 0.1); display: flex; flex-direction: column; }
        #chat-window.active { transform: translateX(0); }
        .msg-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 75%; padding: 12px 18px; border-radius: 22px; font-size: 15px; line-height: 1.4; position: relative; }
        .bubble.me { align-self: flex-end; background: var(--neon); color: #000; border-bottom-right-radius: 4px; font-weight: 500; }
        .bubble.them { align-self: flex-start; background: #262626; color: #fff; border-bottom-left-radius: 4px; }
        .voice-note { display: flex; align-items: center; gap: 10px; cursor: pointer; }

        /* üî± CALL SYSTEM UI */
        #call-screen { position: fixed; inset: 0; background: #000; z-index: 100000; display: none; flex-direction: column; align-items: center; justify-content: space-around; padding: 80px 0; }
        .call-anim { position: absolute; width: 300px; height: 300px; border: 2px solid var(--neon); border-radius: 50%; opacity: 0; animation: pulse 2s infinite; }
        @keyframes pulse { 0% {transform: scale(0.8); opacity: 0;} 50% {opacity: 0.5;} 100% {transform: scale(1.5); opacity: 0;} }
        
        /* üî± CONTROLS */
        .boss-input { background: #1a1a1a; border: none; padding: 18px; border-radius: 15px; color: #fff; width: 100%; outline: none; font-size: 16px; border-bottom: 2px solid transparent; transition: 0.3s; }
        .boss-input:focus { border-bottom-color: var(--neon); }
        .btn-round { width: 60px; height: 60px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; transition: 0.4s; }
        .btn-neon { background: var(--neon); color: #000; box-shadow: 0 0 20px rgba(0,255,136,0.3); }

        /* STATUS BAR MODAL */
        #status-modal { position: fixed; bottom: 0; width: 100%; height: 80vh; background: var(--panel); z-index: 2000; border-radius: 30px 30px 0 0; display: none; padding: 30px; }
    </style>
</head>
<body>

    <div id="setup-layer">
        <div class="setup-card">
            <h1 style="font-family: 'Orbitron'; color: var(--neon);">SOVEREIGN OMEGA</h1>
            <div class="profile-upload" onclick="document.getElementById('file-in').click()">
                <img id="preview-img" src="" style="display:none;">
                <i id="upload-icon" class="fas fa-camera"></i>
            </div>
            <input type="file" id="file-in" hidden onchange="processAvatar(event)">
            <input type="text" id="boss-name" class="boss-input" placeholder="Adƒ±nƒ±zƒ± Daxil Edin">
            <button class="boss-input" style="background: var(--neon); color: #000; font-weight: 800; margin-top: 15px;" onclick="initBoss()">Sƒ∞STEM∆è DAXƒ∞L OL</button>
        </div>
    </div>

    <div class="master-grid">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="avatar-box" id="my-avatar-top"></div>
                <div>
                    <div id="display-name" style="font-weight:800; font-size:18px;">Boss</div>
                    <div id="display-id" style="color:var(--neon); font-size:11px; font-family:'Orbitron';">ID: ...</div>
                </div>
            </div>
            <div style="display:flex; gap:20px; font-size:20px;">
                <i class="fas fa-circle-notch" onclick="openStatus()" style="color:var(--gold);"></i>
                <i class="fas fa-ellipsis-v" onclick="showSettings()"></i>
            </div>
        </div>

        <div class="content-scroll" id="contacts-list">
            </div>

        <div class="top-bar" style="border-top:1px solid #222; border-bottom:none;">
            <input type="text" id="new-contact-id" class="boss-input" style="height:50px;" placeholder="Yeni ID ∆èlav…ô Et">
            <button class="btn-round btn-neon" style="width:50px; height:50px; margin-left:10px;" onclick="addContact()">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <div id="chat-window">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:15px;">
                <i class="fas fa-chevron-left" onclick="closeChat()"></i>
                <div class="avatar-box" id="chat-avatar" style="width:40px; height:40px;"></div>
                <div id="chat-name" style="font-weight:700;">Dost</div>
            </div>
            <div style="display:flex; gap:20px;">
                <i class="fas fa-video" onclick="startCall('video')"></i>
                <i class="fas fa-phone-alt" onclick="startCall('audio')"></i>
            </div>
        </div>
        <div class="msg-container" id="msg-feed"></div>
        <div class="top-bar" style="height:auto; padding:15px; border-top:1px solid #222;">
            <button class="btn-round" style="background:transparent; color:var(--neon);" id="voice-btn" onmousedown="startVoice()" onmouseup="stopVoice()">
                <i class="fas fa-microphone"></i>
            </button>
            <input type="text" id="msg-input" class="boss-input" placeholder="Mesaj yazƒ±n...">
            <button class="btn-round btn-neon" style="width:50px; height:50px; margin-left:10px;" onclick="sendPacket()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="call-screen">
        <div class="call-anim"></div>
        <div class="call-anim" style="animation-delay: 1s;"></div>
        <div style="text-align:center; z-index:10;">
            <div class="avatar-box" style="width:120px; height:120px; margin:0 auto 25px;">
                <img id="call-img" src="">
            </div>
            <h2 id="call-user-name" style="font-family:'Orbitron';">BAƒûLANTI...</h2>
            <p id="call-status" style="color:var(--neon); letter-spacing:3px;">AES-256 ENCRYPTING</p>
        </div>
        <div style="display:flex; gap:40px; z-index:10;">
            <button id="accept-btn" class="btn-round btn-neon" style="width:80px; height:80px; display:none;" onclick="answerCall()">
                <i class="fas fa-phone"></i>
            </button>
            <button class="btn-round" style="width:80px; height:80px; background:var(--danger); color:#fff;" onclick="killAll()">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
        <video id="remote-v" autoplay playsinline style="position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:-1; display:none;"></video>
    </div>

    <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="msg-tone" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<script>
    /* üî± SOVEREIGN OMEGA ENGINE - THE BOSS PROTOCOL */
    const MASTER_KEY = "BOSS_GHOST_OMEGA_99";
    let myPeer, myConfig, activeCall, activeStream, activeConn;
    let chatID = null;
    let mediaRecorder, voiceChunks = [];

    // 1. ƒ∞Nƒ∞Sƒ∞ALƒ∞ZASƒ∞YA (√ñM√úRL√úK PROFƒ∞L)
    function processAvatar(e) {
        const reader = new FileReader();
        reader.onload = () => {
            document.getElementById('preview-img').src = reader.result;
            document.getElementById('preview-img').style.display = 'block';
            document.getElementById('upload-icon').style.display = 'none';
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function initBoss() {
        const name = document.getElementById('boss-name').value.trim();
        const img = document.getElementById('preview-img').src;
        if(!name) return;

        const bossID = "BOSS-" + Math.floor(100000 + Math.random() * 900000);
        myConfig = { id: bossID, name: name, avatar: img, status: "Sovereign Omega Active" };
        
        localStorage.setItem('boss_profile_v2', JSON.stringify(myConfig));
        bootSystem();
    }

    function bootSystem() {
        const stored = JSON.parse(localStorage.getItem('boss_profile_v2'));
        if(!stored) return;

        myConfig = stored;
        document.getElementById('setup-layer').style.display = 'none';
        document.getElementById('display-name').innerText = myConfig.name;
        document.getElementById('display-id').innerText = "ID: " + myConfig.id;
        document.getElementById('my-avatar-top').innerHTML = `<img src="${myConfig.avatar}">`;

        myPeer = new Peer(myConfig.id, {
            config: { 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] }
        });

        myPeer.on('connection', handleDataChannel);
        myPeer.on('call', handleIncomingCall);
        
        renderContacts();
    }

    // 2. DATA BAZA V∆è ≈ûƒ∞FR∆èL∆èM∆è
    const Crypto = {
        seal: (data) => CryptoJS.AES.encrypt(JSON.stringify(data), MASTER_KEY).toString(),
        open: (cipher) => {
            try { 
                const bytes = CryptoJS.AES.decrypt(cipher, MASTER_KEY);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch(e) { return null; }
        }
    };

    function addContact() {
        const id = document.getElementById('new-contact-id').value.trim();
        if(!id || id === myConfig.id) return;

        let db = JSON.parse(localStorage.getItem('boss_db') || "[]");
        if(!db.find(x => x.id === id)) {
            db.push({ id: id, name: "User-" + id.split('-')[1], messages: [], avatar: '' });
            localStorage.setItem('boss_db', JSON.stringify(db));
        }
        renderContacts();
        document.getElementById('new-contact-id').value = "";
    }

    function renderContacts() {
        const list = document.getElementById('contacts-list');
        list.innerHTML = "";
        let db = JSON.parse(localStorage.getItem('boss_db') || "[]");

        db.forEach(c => {
            list.innerHTML += `
                <div class="chat-card" onclick="openChat('${c.id}')">
                    <div class="avatar-box">${c.avatar ? `<img src="${c.avatar}">` : ''}</div>
                    <div style="flex:1;">
                        <div style="font-weight:700;">${c.name}</div>
                        <div style="font-size:12px; color:#666;">Son mesaj ≈üifr…ôlidir...</div>
                    </div>
                    <div style="font-size:10px; color:var(--neon);">ONLAYN</div>
                </div>
            `;
        });
    }

    // 3. MESAJLA≈ûMA V∆è S∆èS
    function openChat(id) {
        chatID = id;
        const db = JSON.parse(localStorage.getItem('boss_db'));
        const user = db.find(x => x.id === id);
        
        document.getElementById('chat-window').classList.add('active');
        document.getElementById('chat-name').innerText = user.name;
        document.getElementById('chat-avatar').innerHTML = user.avatar ? `<img src="${user.avatar}">` : '';
        
        loadMessages();
    }

    function sendPacket() {
        const txt = document.getElementById('msg-input').value.trim();
        if(!txt) return;

        const packet = { type: 'TEXT', body: txt, from: myConfig.id, time: Date.now() };
        saveAndSend(packet);
        document.getElementById('msg-input').value = "";
    }

    function saveAndSend(packet) {
        // Local yadda≈üa yaz
        let db = JSON.parse(localStorage.getItem('boss_db'));
        let idx = db.findIndex(x => x.id === chatID);
        db[idx].messages.push(packet);
        localStorage.setItem('boss_db', JSON.stringify(db));
        
        // P2P G√∂nd…ôr
        const conn = myPeer.connect(chatID);
        conn.on('open', () => {
            conn.send(Crypto.seal(packet));
        });

        loadMessages();
    }

    function handleDataChannel(conn) {
        conn.on('data', (cipher) => {
            const data = Crypto.open(cipher);
            if(data) {
                let db = JSON.parse(localStorage.getItem('boss_db'));
                let idx = db.findIndex(x => x.id === data.from);
                if(idx !== -1) {
                    db[idx].messages.push(data);
                    localStorage.setItem('boss_db', JSON.stringify(db));
                    document.getElementById('msg-tone').play();
                    if(chatID === data.from) loadMessages();
                }
            }
        });
    }

    function loadMessages() {
        const feed = document.getElementById('msg-feed');
        feed.innerHTML = "";
        let db = JSON.parse(localStorage.getItem('boss_db'));
        let user = db.find(x => x.id === chatID);

        user.messages.forEach(m => {
            const side = m.from === myConfig.id ? 'me' : 'them';
            if(m.type === 'TEXT') {
                feed.innerHTML += `<div class="bubble ${side}">${m.body}</div>`;
            } else if(m.type === 'VOICE') {
                feed.innerHTML += `
                    <div class="bubble ${side} voice-note" onclick="playVoice('${m.body}')">
                        <i class="fas fa-play"></i> <span>S…ôsli Mesaj</span>
                    </div>`;
            }
        });
        feed.scrollTop = feed.scrollHeight;
    }

    // 4. S∆èSLƒ∞ MESAJ MOTORU
    async function startVoice() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => voiceChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(voiceChunks, { type: 'audio/ogg; codecs=opus' });
            const reader = new FileReader();
            reader.onload = () => {
                saveAndSend({ type: 'VOICE', body: reader.result, from: myConfig.id, time: Date.now() });
            };
            reader.readAsDataURL(blob);
            voiceChunks = [];
        };
        mediaRecorder.start();
        document.getElementById('voice-btn').style.color = 'var(--danger)';
    }

    function stopVoice() {
        mediaRecorder.stop();
        document.getElementById('voice-btn').style.color = 'var(--neon)';
    }

    function playVoice(data) {
        new Audio(data).play();
    }

    // 5. HD Z∆èNG Sƒ∞STEMƒ∞ (OFLAYN TRIGGER)
    async function startCall(type) {
        document.getElementById('call-screen').style.display = 'flex';
        document.getElementById('ringtone').play();
        
        try {
            activeStream = await navigator.mediaDevices.getUserMedia({ video: type==='video', audio: true });
            const call = myPeer.call(chatID, activeStream);
            setupCallFlow(call);
        } catch(e) { killAll(); }
    }

    function handleIncomingCall(call) {
        document.getElementById('call-screen').style.display = 'flex';
        document.getElementById('accept-btn').style.display = 'block';
        document.getElementById('ringtone').play();
        activeCall = call;
    }

    async function answerCall() {
        document.getElementById('ringtone').pause();
        activeStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        activeCall.answer(activeStream);
        setupCallFlow(activeCall);
    }

    function setupCallFlow(call) {
        call.on('stream', (remoteStream) => {
            document.getElementById('ringtone').pause();
            const rv = document.getElementById('remote-v');
            rv.srcObject = remoteStream;
            rv.style.display = 'block';
            document.getElementById('call-status').innerText = "LIVE CONNECTION";
        });
    }

    function killAll() { location.reload(); }
    function closeChat() { document.getElementById('chat-window').classList.remove('active'); chatID = null; }

    window.onload = () => { if(localStorage.getItem('boss_profile_v2')) bootSystem(); };
</script>
</body>
</html>
