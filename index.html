<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ISMAIL BOSS | V40 PHANTOM</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root { --neon: #00ff41; --danger: #ff003c; --blue: #00f2ff; --bg: #000000; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; font-family: 'Orbitron', sans-serif; }

        /* ARXA PLAN */
        #matrix-bg { position: fixed; inset: 0; z-index: -1; opacity: 0.15; }

        /* 1. INTRO (3 Saniyə) */
        #intro-screen { position: fixed; inset: 0; z-index: 5000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .intro-txt { font-size: 2.5rem; color: var(--neon); letter-spacing: 4px; animation: glitch 0.3s infinite; text-align: center; }

        /* 2. LOGIN */
        #login-screen { position: fixed; inset: 0; z-index: 4000; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .role-btn { width: 280px; padding: 25px; border: 2px solid var(--neon); background: transparent; color: var(--neon); font-size: 1.2rem; font-weight: 900; cursor: pointer; transition: 0.2s; font-family: 'Orbitron'; }
        .role-btn:active { background: var(--neon); color: #000; transform: scale(0.95); }
        .boss-style { border-color: var(--blue); color: var(--blue); }
        .boss-style:active { background: var(--blue); }

        /* 3. SCAN (Status Ekranı) */
        #scan-screen { position: fixed; inset: 0; z-index: 3000; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .radar-ring { width: 200px; height: 200px; border: 2px solid #333; border-radius: 50%; position: relative; box-shadow: 0 0 30px var(--neon); }
        .radar-line { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(transparent 270deg, var(--neon)); animation: spin 2s linear infinite; }
        .status-log { margin-top: 40px; color: var(--neon); font-family: 'Share Tech Mono'; font-size: 14px; text-align: center; line-height: 1.5; min-height: 50px; }
        .retry-btn { margin-top: 20px; padding: 10px 30px; background: var(--danger); border: none; color: white; display: none; cursor: pointer; font-weight: bold; animation: pulse 1s infinite; }

        /* 4. MAIN APP */
        #app-screen { position: fixed; inset: 0; z-index: 100; display: none; flex-direction: column; background: #050505; }
        .top-bar { padding: 15px; border-bottom: 2px solid var(--neon); display: flex; justify-content: space-between; align-items: center; background: #000; box-shadow: 0 5px 20px rgba(0,255,65,0.1); }
        .feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .bubble { padding: 12px 18px; border-radius: 6px; max-width: 85%; font-family: 'Share Tech Mono'; font-size: 15px; word-break: break-word; position: relative; }
        .me { align-self: flex-end; background: rgba(0, 242, 255, 0.1); border: 1px solid var(--blue); color: var(--blue); border-right: 4px solid var(--blue); }
        .them { align-self: flex-start; background: rgba(0, 255, 65, 0.1); border: 1px solid var(--neon); color: var(--neon); border-left: 4px solid var(--neon); }
        
        .bot-bar { padding: 15px; background: #000; border-top: 1px solid var(--neon); display: flex; gap: 15px; align-items: center; }
        .msg-box { flex: 1; background: #111; border: 1px solid #333; color: white; padding: 15px; font-family: 'Share Tech Mono'; border-radius: 4px; }

        /* 5. CALL OVERLAY */
        #call-ui { position: fixed; inset: 0; z-index: 6000; background: rgba(0,0,0,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; }
        .call-icon { font-size: 80px; color: var(--neon); margin-bottom: 20px; animation: vibrate 0.5s infinite; }
        .call-txt { font-size: 2rem; color: #fff; margin-bottom: 50px; text-align: center; letter-spacing: 2px; }
        .btn-row { display: flex; gap: 40px; }
        .c-btn { width: 75px; height: 75px; border-radius: 50%; border: none; font-size: 30px; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .accept { background: #00c853; box-shadow: 0 0 25px #00c853; }
        .reject { background: #d50000; box-shadow: 0 0 25px #d50000; }

        /* 6. VIDEO */
        #vid-layer { position: fixed; inset: 0; z-index: 5500; background: #000; display: none; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; border: 2px solid var(--neon); background: #000; object-fit: cover; border-radius: 5px; }
        .end-call { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; background: var(--danger); border-radius: 50%; border: none; color: #fff; font-size: 25px; cursor: pointer; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes glitch { 0% { transform: skew(10deg); opacity: 0.8; } 100% { transform: skew(-10deg); opacity: 1; } }
        @keyframes vibrate { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
        @keyframes pulse { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <canvas id="matrix-bg"></canvas>

    <div id="intro-screen">
        <h1 class="intro-txt">V40 PHANTOM</h1>
        <small style="color:#555; margin-top:10px;">ENCRYPTED SYSTEM INITIALIZING...</small>
    </div>

    <div id="login-screen">
        <button class="role-btn boss-style" onclick="bootSystem('BOSS')">BOSS (HOST)</button>
        <button class="role-btn" onclick="bootSystem('GUEST')">QONAQ (JOIN)</button>
    </div>

    <div id="scan-screen">
        <div class="radar-ring"><div class="radar-line"></div></div>
        <div class="status-log" id="status-log">NETWORK SCANNING...</div>
        <button class="retry-btn" id="force-btn" onclick="forceRetry()">MƏCBURİ QOŞUL</button>
    </div>

    <div id="app-screen">
        <div class="top-bar">
            <div><b style="color:var(--neon)">ISMAIL BOSS V40</b><br><small style="color:#888; font-size:10px;">SECURE TUNNEL ACTIVE</small></div>
            <div style="display:flex; gap:20px;">
                <i class="fas fa-video fa-lg" style="color:var(--blue)" onclick="prepCall('video')"></i>
                <i class="fas fa-phone-alt fa-lg" style="color:var(--neon)" onclick="prepCall('audio')"></i>
            </div>
        </div>
        <div class="feed" id="chat-feed"></div>
        <div class="bot-bar">
            <i class="fas fa-microphone fa-lg" id="mic-icon" style="color:var(--neon)" onmousedown="recOn()" onmouseup="recOff()" ontouchstart="recOn()" ontouchend="recOff()"></i>
            <input type="text" class="msg-box" id="msg-in" placeholder="Şifrəli mesaj...">
            <i class="fas fa-paper-plane fa-lg" style="color:var(--blue)" onclick="sendTxt()"></i>
        </div>
    </div>

    <div id="call-ui">
        <i class="fas fa-user-secret call-icon"></i>
        <div class="call-txt" id="call-txt">GƏLƏN ZƏNG...</div>
        <div id="inc-btns" class="btn-row" style="display:none;">
            <button class="c-btn reject" onclick="answerCall(false)"><i class="fas fa-times"></i></button>
            <button class="c-btn accept" onclick="answerCall(true)"><i class="fas fa-phone"></i></button>
        </div>
        <div id="out-btns" class="btn-row" style="display:none;">
            <button class="c-btn reject" onclick="cancelCall()"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div id="vid-layer">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline></video>
        <button class="end-call" onclick="terminateCall()"><i class="fas fa-phone-slash"></i></button>
    </div>

<script>
// --- CORE CONFIG ---
const KEY = "V40_ISMAIL_BOSS_SECURE";
const BOSS_ID = "ISMAIL-V40-HOST-X99"; // Sabit BOSS ID-si
let role, peer, conn, myStream, curCall, callType;
let mediaRec, chunks = [];

// Səslər
const audRing = new Audio("https://cdn.freesound.org/previews/538/538006_11674332-lq.mp3");
const audDial = new Audio("https://cdn.freesound.org/previews/336/336986_5939023-lq.mp3");
audRing.loop = true; audDial.loop = true;

// STUN Serverlər (Gücləndirilmiş)
const ICE_CONFIG = {
    'iceServers': [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
    ]
};

// --- 1. BOOT ---
window.onload = () => {
    drawMatrix();
    setTimeout(() => {
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
    }, 2500);
};

function log(txt) {
    const el = document.getElementById('status-log');
    el.innerHTML = txt;
}

// --- 2. NETWORK LOGIC (FIXED) ---
function bootSystem(selectedRole) {
    role = selectedRole;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('scan-screen').style.display = 'flex';
    
    // Qonaq üçün unikal ID, Boss üçün sabit ID
    const myId = (role === 'BOSS') ? BOSS_ID : "GUEST-" + Math.floor(Math.random() * 999999);
    
    // Peer yaradılır
    log("SERVERƏ SORĞU GÖNDƏRİLİR...");
    peer = new Peer(myId, { config: ICE_CONFIG, debug: 1 });

    peer.on('open', (id) => {
        log(`SERVERDƏ TƏSDİQLƏNDİ.<br>ID: ${id}<br>QARŞI TƏRƏF AXTARILIR...`);
        if(role === 'GUEST') {
            connectLoop(); // Qonaq dərhal axtarışa başlayır
        } else {
            log("HOST AKTİVDİR.<br>QONAQ GÖZLƏNİLİR...");
        }
    });

    peer.on('connection', (c) => {
        conn = c;
        readyUp();
    });

    peer.on('error', (err) => {
        log("XƏTA: " + err.type + "<br>YENİDƏN CƏHD EDİLİR...");
        if(role === 'BOSS' && err.type === 'unavailable-id') {
            alert("Sistemdə 'BOSS' artıq var. Digər tabları bağlayın və səhifəni yeniləyin.");
        }
        setTimeout(() => document.getElementById('force-btn').style.display = 'block', 2000);
    });
}

// Qonaq üçün təkrar qoşulma dövrü (THE FIX)
function connectLoop() {
    if(conn) return; // Artıq qoşulubsa dayan
    log("BOSS AXTARILIR... (CƏHD EDİLİR)");
    
    const c = peer.connect(BOSS_ID, { reliable: true });
    
    c.on('open', () => {
        conn = c;
        readyUp();
    });

    c.on('error', (e) => {
        log("BOSS TAPILMADI, YENİDƏN YOXLANILIR...");
        setTimeout(connectLoop, 2000); // 2 saniyə sonra təkrar
    });

    // Əgər 5 saniyə sonra hələ də qoşulmayıbsa, düyməni göstər
    setTimeout(() => {
        if(!conn) document.getElementById('force-btn').style.display = 'block';
    }, 5000);
}

function forceRetry() {
    location.reload(); // Ən təmiz yol səhifəni yeniləməkdir
}

function readyUp() {
    log("UĞURLU! TƏHLÜKƏSİZ TUNEL QURULDU.");
    document.querySelector('.radar-line').style.background = "var(--blue)";
    
    // Data dinləmə
    conn.on('data', (raw) => {
        try {
            const dec = CryptoJS.AES.decrypt(raw, KEY).toString(CryptoJS.enc.Utf8);
            const data = JSON.parse(dec);
            handleData(data);
        } catch(e) { console.log("Crypt Error"); }
    });

    setTimeout(() => {
        document.getElementById('scan-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
    }, 1000);
}

// --- 3. COMMUNICATION ---
function send(type, content) {
    if(conn && conn.open) {
        const enc = CryptoJS.AES.encrypt(JSON.stringify({t: type, c: content}), KEY).toString();
        conn.send(enc);
    }
}

function handleData(d) {
    if(d.t === 'txt') addMsg(d.c, 'them');
    if(d.t === 'aud') addAud(d.c, 'them');
    if(d.t === 'call_req') incCall(d.c);
    if(d.t === 'call_ans') startCallStream(true); // O qəbul etdi, mən başlatdım
    if(d.t === 'call_end') terminateCall(true);
}

// Mesaj
function sendTxt() {
    const i = document.getElementById('msg-in');
    if(!i.value) return;
    addMsg(i.value, 'me');
    send('txt', i.value);
    i.value = "";
}
function addMsg(t, w) {
    const d = document.createElement('div');
    d.className = `bubble ${w}`;
    d.innerText = t;
    const f = document.getElementById('chat-feed');
    f.appendChild(d); f.scrollTop = f.scrollHeight;
}

// Audio Rec
function recOn() {
    navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
        mediaRec = new MediaRecorder(s);
        chunks = [];
        mediaRec.ondataavailable = e => chunks.push(e.data);
        mediaRec.onstop = () => {
            const r = new FileReader();
            r.readAsDataURL(new Blob(chunks));
            r.onload = () => { addAud(r.result, 'me'); send('aud', r.result); };
        };
        mediaRec.start();
        document.getElementById('mic-icon').style.color = 'var(--danger)';
    });
}
function recOff() { if(mediaRec) { mediaRec.stop(); document.getElementById('mic-icon').style.color = 'var(--neon)'; } }
function addAud(src, w) {
    const d = document.createElement('div');
    d.className = `bubble ${w}`;
    d.innerHTML = `<div onclick="new Audio('${src}').play()" style="cursor:pointer; display:flex; align-items:center; gap:10px;"><i class="fas fa-play"></i> SƏSLİ MESAJ</div>`;
    document.getElementById('chat-feed').appendChild(d);
}

// --- 4. CALL LOGIC ---
function prepCall(type) {
    callType = type;
    document.getElementById('call-ui').style.display = 'flex';
    document.getElementById('call-txt').innerText = "ZƏNG EDİLİR...";
    document.getElementById('out-btns').style.display = 'flex';
    document.getElementById('inc-btns').style.display = 'none';
    audDial.play();
    send('call_req', type);
}

function incCall(type) {
    callType = type;
    document.getElementById('call-ui').style.display = 'flex';
    document.getElementById('call-txt').innerText = (type==='video' ? "GÖRÜNTÜLÜ" : "SƏSLİ") + " ZƏNG";
    document.getElementById('inc-btns').style.display = 'flex';
    document.getElementById('out-btns').style.display = 'none';
    audRing.play();
}

function answerCall(yes) {
    audRing.pause(); audRing.currentTime = 0;
    if(yes) {
        send('call_ans', 'ok');
        startCallStream(false); // Mən qəbul etdim
    } else {
        document.getElementById('call-ui').style.display = 'none';
        send('call_end', 'rej');
    }
}

function cancelCall() {
    audDial.pause(); audDial.currentTime = 0;
    document.getElementById('call-ui').style.display = 'none';
    send('call_end', 'cancel');
}

async function startCallStream(isInitiator) {
    document.getElementById('call-ui').style.display = 'none';
    audDial.pause();
    document.getElementById('vid-layer').style.display = 'block';
    
    const useVid = (callType === 'video');
    try {
        myStream = await navigator.mediaDevices.getUserMedia({ video: useVid, audio: true });
        document.getElementById('local-v').srcObject = myStream;

        if(isInitiator) {
            curCall = peer.call(conn.peer, myStream);
            handleStream(curCall);
        } else {
            peer.on('call', (call) => {
                call.answer(myStream);
                handleStream(call);
            });
        }
    } catch(e) { alert("Kamera xətası: " + e); terminateCall(); }
}

function handleStream(call) {
    curCall = call;
    call.on('stream', rS => { document.getElementById('remote-v').srcObject = rS; });
    call.on('close', () => terminateCall(true));
}

function terminateCall(remote = false) {
    if(!remote) send('call_end', 'bye');
    if(curCall) curCall.close();
    if(myStream) myStream.getTracks().forEach(t => t.stop());
    document.getElementById('vid-layer').style.display = 'none';
    document.getElementById('call-ui').style.display = 'none';
    audDial.pause(); audRing.pause();
}

// Matrix
function drawMatrix() {
    const c = document.getElementById('matrix-bg');
    const x = c.getContext('2d');
    c.width = window.innerWidth; c.height = window.innerHeight;
    const drops = Array(Math.floor(c.width/20)).fill(1);
    function anim() {
        x.fillStyle = "rgba(0,0,0,0.1)"; x.fillRect(0,0,c.width,c.height);
        x.fillStyle = "#0f0"; x.font = "15px monospace";
        drops.forEach((y, i) => {
            x.fillText(Math.random()>0.5?"1":"0", i*20, y*20);
            if(y*20 > c.height && Math.random()>0.975) drops[i]=0;
            drops[i]++;
        });
        requestAnimationFrame(anim);
    }
    anim();
}
</script>
</body>
</html>






